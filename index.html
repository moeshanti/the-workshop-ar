<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>The Workshop | AR Companion</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCg7B8tiS2_Kn_Ktl07SqA7NKBc_O7Rb3U",
      authDomain: "the-workshop-ar.firebaseapp.com",
      projectId: "the-workshop-ar",
      storageBucket: "the-workshop-ar.firebasestorage.app",
      messagingSenderId: "12749243592",
      appId: "1:12749243592:web:ea3341aa65354acdd051fd"
    };

    let db;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      console.log("Firebase Init Success");
    } catch(e) { console.error(e); }

    window.submitRating = async (stars) => {
      alert("Rating Clicked: " + stars); // Instant feedback
      if(db) {
         await addDoc(collection(db, "ratings"), { stars: stars, time: serverTimestamp() });
         document.getElementById('feedback').innerText = "Saved!";
      }
    }
  </script>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    /* NUCLEAR CSS FIX */
    body { margin: 0; overflow: hidden; }
    
    /* 1. The AR Layer (Background) */
    #scene-container { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        z-index: 1; 
    }

    /* 2. The UI Layer (Foreground) */
    #ui-layer {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 9999; /* Highest priority */
        pointer-events: none; /* Let clicks pass through empty space */
        display: flex; flex-direction: column; justify-content: space-between;
    }

    /* 3. Interactive Elements (Must catch clicks) */
    .interactive {
        pointer-events: auto !important; /* Force clickability */
        cursor: pointer;
    }

    /* Debug Visuals */
    .debug-box { background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; color: white; margin: 10px; }
  </style>

  <script>
    const GALLERY_DATA = { 
        title: "The Butterfly Voyage", 
        artist: "Julian Doe", 
        price: "AED 15,000" 
    };

    function showCard() {
        document.getElementById('card-panel').classList.remove('hidden');
        document.getElementById('scan-text').classList.add('hidden');
    }

    // AR EVENT LISTENERS
    document.addEventListener("DOMContentLoaded", () => {
        const scene = document.querySelector('a-scene');
        const target = document.getElementById('target');

        target.addEventListener("targetFound", () => {
            console.log("Target Found");
            showCard(); // Trigger UI
        });
    });
  </script>
</head>
<body>

  <div id="scene-container">
    <a-scene 
      mindar-image="imageTargetSrc: ./assets/targets.mind; uiScanning: no; uiLoading: no;" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-entity id="target" mindar-image-target="targetIndex: 0">
        <a-gltf-model src="./assets/moon.glb" position="0 0 0" scale="0.5 0.5 0.5"></a-gltf-model>
        <a-gltf-model src="./assets/butterflies.glb" position="0.5 0 0" scale="0.01 0.01 0.01" animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"></a-gltf-model>
      </a-entity>
    </a-scene>
  </div>

  <div id="ui-layer">
    
    <div class="w-full flex justify-start p-4">
        <button onclick="showCard()" class="interactive bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-xl border-2 border-white">
            FORCE SHOW UI
        </button>
    </div>

    <div id="scan-text" class="text-white text-center text-xl font-bold drop-shadow-md mt-20">
        SCAN PAINTING
    </div>

    <div id="card-panel" class="interactive hidden m-4 bg-white rounded-xl shadow-2xl p-6 mb-10">
        <h2 class="text-2xl font-bold text-gray-800">The Butterfly Voyage</h2>
        <p class="text-gray-500">Julian Doe</p>
        
        <div class="flex gap-4 my-4 justify-center">
            <button onclick="submitRating(1)" class="interactive text-3xl hover:scale-110">⭐</button>
            <button onclick="submitRating(5)" class="interactive text-3xl hover:scale-110">⭐⭐⭐⭐⭐</button>
        </div>
        <div id="feedback" class="text-center text-green-600 font-bold"></div>

        <button onclick="window.open('https://wa.me/971500000000', '_blank')" class="interactive w-full bg-green-500 text-white font-bold py-4 rounded-lg mt-2 text-lg">
            INQUIRE (AED 15,000)
        </button>
    </div>
  </div>

</body>
</html>
